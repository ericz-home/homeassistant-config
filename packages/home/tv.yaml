tv:
  automation:
    # turn on light and tv
    - id: turn_on_light_and_tv
      alias: "Turn on Light and TV"
      triggers:
        - device_id: 0d1e1ef71dff51f437db183f4d67d7ed
          domain: mqtt
          type: action
          subtype: config_single
          trigger: device
      conditions:
        - condition: state
          entity_id: media_player.sony_xr_75x90j
          state: "off"
      actions:
        - alias: "turn on light"
          action: light.turn_on
          target:
            entity_id: light.tv_room_light
        - alias: "turn on tv"
          action: media_player.turn_on
          target:
            entity_id: media_player.sony_xr_75x90j
    # turn off light when playing media
    - id: turn_off_light_when_playing_media
      alias: "Turn off Light when Playing Media"
      triggers:
        - platform: template
          value_template: "{{ state_attr('media_player.sony_tv', 'media_content_type') is not none }}"
          for: 
            seconds: 30
      conditions:
        - condition: state
          entity_id: light.tv_room_light
          state: "on"
      actions:
        - alias: "turn off light"
          action: light.turn_off
          target:
            entity_id: light.tv_room_light
    - id: turn_on_light_when_tv_off
      alias: "Turn on Light when TV is Off"
      triggers:
        - platform: state
          entity_id: media_player.sony_xr_75x90j
          to: "off"
          from: "on"
      conditions:
        - condition: state
          entity_id: light.tv_room_light
          state: "off"
        - condition: sun
          after: sunset
          after_offset: "-00:30:00"
          before: sunrise
      actions:
        - alias: "turn on light"
          action: light.turn_on
          target:
            entity_id: light.tv_room_light

  script:
    play_tv:
      description: "play media on tv"
      fields:
        media_content_id:
          description: "content id"
        media_content_type:
          description: "content type"
      sequence:
        - if: 
            - alias: "tv is off"
              condition: state
              entity_id: media_player.sony_xr_75x90j
              state: "off"
          then:
            - alias: "turn tv on"
              action: media_player.turn_on
              target:
                entity_id: media_player.sony_xr_75x90j
            - alias: "wait for tv to turn on"
              wait_template: "{{ is_state('media_player.sony_xr_75x90j', 'on') }}"
        - alias: "switch to media"
          action: media_player.play_media
          target:
            entity_id: media_player.sony_xr_75x90j
          data:
            media_content_id: "{{ media_content_id }}"
            media_content_type: "{{ media_content_type }}"

    play_source:
      description: "select source on tv"
      fields:
        source:
          description: "source"
      sequence:
        - if: 
            - alias: "tv is off"
              condition: state
              entity_id: media_player.sony_xr_75x90j
              state: "off"
          then:
            - alias: "turn tv on"
              action: media_player.turn_on
              target:
                entity_id: media_player.sony_xr_75x90j
            - alias: "wait for tv to turn on"
              wait_template: "{{ is_state('media_player.sony_xr_75x90j', 'on') }}"
        - alias: "switch to source"
          action: media_player.select_source
          target:
            entity_id: media_player.sony_xr_75x90j
          data:
            source: "{{ source }}"
